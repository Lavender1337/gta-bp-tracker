<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BP Farm Tracker</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
  :root{
    --bg-1:#070707;
    --bg-2:#0f111a; 
    --panel:rgba(20, 22, 30, 0.95);
    --muted:#7a7a7a;
    --text:#f4f4f4;
    --accent:#00aaff; 
    --accent2:#00e0ff; 
    --neon:rgba(0, 170, 255, 0.15); 
    --danger:#ff4444;
    --success:#00cc66;
    --radius:12px;
  }

  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent; outline: none;}
  
  body{ 
    margin:0; 
    font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background:var(--bg-1); 
    color:var(--text); 
    padding:12px; 
    padding-bottom: 80px;
    font-size: 14px;
  }
  
  body.tg-active { background: var(--tg-theme-bg-color, var(--bg-1)); }

  .wrap{max-width:800px;margin:0 auto}
  
  /* –•–µ–¥–µ—Ä */
  header{ 
    display:flex; flex-direction: column; gap:10px;
    padding:12px; border-radius:var(--radius); 
    background:var(--panel); 
    border:1px solid rgba(255,255,255,0.05); 
    margin-bottom: 16px;
  }
  
  .header-top { display: flex; justify-content: space-between; align-items: center; }
  .logo { font-weight: 900; color: var(--accent2); font-size: 18px; display: flex; align-items: center; gap: 8px;}
  .logo span { background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

  .controls-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; }
  .controls-row::-webkit-scrollbar { display: none; }
  
  /* –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º */
  input, select { 
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
    color: var(--text); padding: 8px; border-radius: 8px; font-size: 14px;
  }
  input:focus { border-color: var(--accent); }
  
  /* –ö–Ω–æ–ø–∫–∏ */
  .btn { 
    background: linear-gradient(90deg, var(--accent2), var(--accent)); 
    color: #000; font-weight: 600; border: none; padding: 8px 14px; 
    border-radius: 8px; cursor: pointer; font-size: 13px; white-space: nowrap;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn:active { opacity: 0.8; transform: scale(0.98); }
  
  .btn.ghost { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid rgba(255,255,255,0.05); }
  .btn.ghost:active { background: rgba(255,255,255,0.1); }
  .btn.danger { background: rgba(255, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
  .btn.success { background: rgba(0, 204, 102, 0.2); color: var(--success); border: 1px solid var(--success); }
  
  .btn-icon { background: transparent; border: none; color: var(--muted); padding: 8px; font-size: 16px; cursor: pointer; }
  
  /* –ü–∞–Ω–µ–ª–∏ */
  .panel { background: var(--panel); padding: 14px; border-radius: var(--radius); margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.03); }
  
  /* –ó–∞–¥–∞—á–∏ */
  .task { 
    display: flex; align-items: center; gap: 10px; padding: 10px; 
    background: rgba(255,255,255,0.02); border-radius: 10px; margin-bottom: 8px; 
    border: 1px solid rgba(255,255,255,0.03);
  }
  .task.completed { border-left: 3px solid var(--success); opacity: 0.8; }
  .task-content { flex: 1; }
  .task-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .task-info { font-size: 11px; color: var(--muted); }
  .task-info span.green { color: var(--success); }
  .bp-badge { background: #1a1a1a; color: var(--accent2); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid #333; }

  /* –ì—Ä—É–ø–ø—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
  #bpGroupFilters { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .filter-btn { background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 8px; font-size: 12px; color: var(--muted); border: none; }
  .filter-btn.active { background: var(--accent); color: #000; font-weight: bold; }

  /* –¢–∞–π–º–µ—Ä—ã */
  #timerPanel { display: none; }
  .timer-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--muted); }
  .timer-item.active { border-left-color: var(--accent); }
  .timer-item.paused { border-left-color: #fca5a5; }
  .timer-time { font-family: monospace; font-size: 14px; font-weight: bold; color: var(--accent2); }

  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ) */
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.2s; }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  .modal { background: #1a1c24; width: 90%; max-width: 320px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: scale(0.9); transition: 0.2s; }
  .modal-overlay.open .modal { transform: scale(1); }
  .modal h3 { margin: 0 0 15px 0; color: var(--text); font-size: 18px; text-align: center; }
  .modal input { width: 100%; margin-bottom: 15px; padding: 10px; font-size: 16px; }
  .modal-buttons { display: flex; gap: 10px; }
  .modal-buttons button { flex: 1; }

  /* –ü–æ–ø–æ–≤–µ—Ä –¥–ª—è –∑–∞–¥–∞—á */
  #taskPopover { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1c24; border-radius: 16px 16px 0 0; padding: 16px; z-index: 100; transform: translateY(100%); transition: 0.3s ease; max-height: 70vh; overflow-y: auto; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
  #taskPopover.open { transform: translateY(0); }
  .popover-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; }
  .popover-item:active { background: rgba(255,255,255,0.05); }

  /* –¢–æ—Å—Ç—ã */
  #toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: 0.3s; z-index: 300; pointer-events: none; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="header-top">
      <div class="logo">BP <span>Farm</span></div>
      <div class="header-stat">
        <span id="totalBP" style="color:var(--accent2)">0</span> BP
        <span id="totalTime" style="color:var(--muted); font-weight:400; font-size: 11px;">0 –º–∏–Ω</span>
      </div>
      <button class="btn-icon" id="toggleTimers">‚è±Ô∏è</button>
    </div>
    
    <div class="controls-row">
       <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫..." style="flex:1; min-width: 100px;">
       <select id="sortSelect" style="width: 80px;">
         <option value="eff">Effic.</option>
         <option value="time">Time</option>
         <option value="manual">Man.</option>
       </select>
       <button class="btn ghost" id="goldenDay" style="font-size: 11px;">Gold</button>
    </div>
    
    <div class="controls-row">
       <button class="btn ghost" id="dailyReset" style="flex:1; font-size:12px;">–°–±—Ä–æ—Å –¥–Ω—è</button>
       <button class="btn ghost" id="saveBtn" style="flex:1; font-size:12px;">Save</button>
       <button class="btn ghost" id="loadBtn" style="flex:1; font-size:12px;">Load</button>
       <input type="file" id="fileInput" style="display:none">
    </div>
  </header>

  <section class="panel" id="timerPanel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <select id="profileSelect" style="flex:1; margin-right:10px;"></select>
        <button class="btn ghost" id="addProfileBtn">+</button>
        <button class="btn-icon delete" id="delProfileBtn">üóëÔ∏è</button>
    </div>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="newTimerInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞..." style="flex:1;">
        <button class="btn" id="addTimerBtn">+</button>
    </div>
    <div id="timerList"></div>
  </section>

  <section class="panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span style="font-weight:700; font-size:16px;">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ <span id="activeCount" style="color:var(--muted); font-size:12px;">0</span></span>
        <button class="btn ghost" id="markAllBtn" style="padding: 4px 8px; font-size: 11px;">–í—Å–µ ‚úì</button>
    </div>
    
    <div id="activeList">
        <div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">
            –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.<br>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∂–µ üëá
        </div>
    </div>
    
    <div id="bpGroupFilters"></div>
    
    <div style="margin-top:20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top:10px;">
        <div id="completedHeader" style="font-weight:700; cursor:pointer; display:flex; align-items:center;">
             <span style="margin-right:5px;">‚ñº</span> –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ <span id="completedCount" style="margin-left:5px; color:var(--muted);">0</span>
             <button class="btn ghost" id="unmarkAllBtn" style="margin-left:auto; padding: 4px 8px; font-size: 11px;">–°–Ω—è—Ç—å ‚úì</button>
        </div>
        <div id="completedList" style="margin-top:10px;"></div>
    </div>
  </section>
</div>

<div class="modal-overlay" id="uniModalOverlay">
  <div class="modal">
    <h3 id="uniModalTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
    <div id="uniModalContent"></div> <div class="modal-buttons">
      <button class="btn ghost" id="uniModalCancel">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn" id="uniModalOk">OK</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="popoverOverlay"></div>
<div id="taskPopover"></div>

<div id="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

<script>
// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ---
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    // –ö—Ä–∞—Å–∏–º —Ö–µ–¥–µ—Ä
    document.documentElement.style.setProperty('--bg-1', window.Telegram.WebApp.themeParams.bg_color || '#070707');
    document.documentElement.style.setProperty('--panel', window.Telegram.WebApp.themeParams.section_bg_color || '#14161e');
}

// --- –î–ê–ù–ù–´–ï ---
const ALL_TASKS = [
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'3 —á–∞—Å–∞ –≤ –æ–Ω–ª–∞–π–Ω–µ', bp:'2/4', time:180, multi:true},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'–ù—É–ª–∏ –≤ –∫–∞–∑–∏–Ω–æ', bp:'2/4', time:12},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'25 –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ', bp:'2/4', time:25},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'25 –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø–æ—Ä—Ç—É', bp:'2/4', time:30},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'25 –¥–µ–π—Å—Ç–≤–∏–π –≤ —à–∞—Ö—Ç–µ', bp:'2/4', time:30},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'10 –ø–æ—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ—á—Ç–µ', bp:'1/2', time:100},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∫–∏–Ω–æ—Å—Ç—É–¥–∏—é', bp:'2/4', time:1},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'–ö—É–ø–∏—Ç—å –ª–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç', bp:'1/2', time:1},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'–í—ã–∏–≥—Ä–∞—Ç—å –≥–æ–Ω–∫—É –≤ –∫–∞—Ä—Ç–∏–Ω–≥–µ', bp:'1/2', time:8},
  {group:'–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö', title:'10 –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ñ–µ—Ä–º–µ', bp:'1/2', time:12},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'7 –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ—Ñ–∏—Ç–∏', bp:'1/2', time:15},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'–°–¥–∞—Ç—å 5 –∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥—ã', bp:'2/4', time:30},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'–°–¥–∞—Ç—å –•–∞–º–º–µ—Ä —Å –í–ó–•', bp:'3/6', time:20},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'5 –≤—ã–¥–∞–Ω–Ω—ã—Ö –º–µ–¥–∫–∞—Ä—Ç', bp:'2/4', time:18},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'–ó–∞–∫—Ä—ã—Ç—å 15 –≤—ã–∑–æ–≤–æ–≤ EMS', bp:'2/4', time:30},
  {group:'–§—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ', title:'–í–∑–ª–æ–º–∞—Ç—å 15 –∑–∞–º–∫–æ–≤', bp:'2/4', time:35},
  {group:'–ù–û–í–û–ï', title:'–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫–µ–π—Å –∑–∞ DP', bp:'10/20', time:2},
  {group:'–ù–û–í–û–ï', title:'–ü–æ—á–∏–Ω–∏—Ç—å –¥–µ—Ç–∞–ª—å –∞–≤—Ç–æ', bp:'1/2', time:3},
  {group:'–ù–û–í–û–ï', title:'–ö–∏–Ω—É—Ç—å –º—è—á –ø–∏—Ç–æ–º—Ü—É 15 —Ä–∞–∑', bp:'2/4', time:8},
  {group:'–ù–û–í–û–ï', title:'–°—ã–≥—Ä–∞—Ç—å –≤ –º–∞—Ñ–∏—é', bp:'3/6', time:15},
  {group:'–ù–û–í–û–ï', title:'–ü–æ—Å–∞–¥–∏—Ç—å —Ç—Ä–∞–≤—É', bp:'4/8', time:20}
];

const GOLDEN_TITLES = ["–ü–æ—Å–µ—Ç–∏—Ç—å –ª—é–±–æ–π —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ", "–ó–∞–π—Ç–∏ –≤ –ª—é–±–æ–π –∫–∞–Ω–∞–ª –≤ Brawl", "–ö—É–ø–∏—Ç—å –ª–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç", "10 –ø–æ—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ—á—Ç–µ", "25 –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ"];

// --- –°–û–°–¢–û–Ø–ù–ò–ï ---
let state = {
    active: [],
    completed: [],
    available: [],
    profiles: { "default": { name: "–û—Å–Ω–æ–≤–Ω–æ–π", timers: [] } },
    currentProfile: "default",
    sort: "manual",
    timersVisible: false
};

// --- –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–û–ö (–ó–∞–º–µ–Ω–∞ prompt/confirm) ---
const modal = {
    overlay: document.getElementById('uniModalOverlay'),
    title: document.getElementById('uniModalTitle'),
    content: document.getElementById('uniModalContent'),
    okBtn: document.getElementById('uniModalOk'),
    cancelBtn: document.getElementById('uniModalCancel'),
    callback: null,

    showInput: function(title, placeholder, onOk) {
        this.title.textContent = title;
        this.content.innerHTML = `<input type="text" id="uniInput" placeholder="${placeholder}">`;
        this.okBtn.textContent = 'OK';
        this.okBtn.className = 'btn';
        this.overlay.classList.add('open');
        document.getElementById('uniInput').focus();
        
        this.callback = () => {
            const val = document.getElementById('uniInput').value;
            if(val) onOk(val);
            this.close();
        };
    },

    showConfirm: function(title, onOk) {
        this.title.textContent = title;
        this.content.innerHTML = '';
        this.okBtn.textContent = '–î–∞';
        this.okBtn.className = 'btn danger';
        this.overlay.classList.add('open');
        
        this.callback = () => {
            onOk();
            this.close();
        };
    },

    close: function() {
        this.overlay.classList.remove('open');
        this.callback = null;
    }
};

modal.okBtn.addEventListener('click', () => { if(modal.callback) modal.callback(); });
modal.cancelBtn.addEventListener('click', () => modal.close());


// --- –õ–û–ì–ò–ö–ê ---
function init() {
    loadData();
    if(state.available.length === 0) {
        state.available = ALL_TASKS.map(t => ({...t, id: Math.random().toString(36).substr(2,9)}));
    }
    render();
}

function render() {
    // –†–µ–Ω–¥–µ—Ä –ê–∫—Ç—É–∞–ª—å–Ω—ã—Ö
    const activeList = document.getElementById('activeList');
    activeList.innerHTML = '';
    if(state.active.length === 0) activeList.innerHTML = '<div style="text-align:center; padding: 20px; color: var(--muted); font-size: 13px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç.<br>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∏–∂–µ üëá</div>';
    
    state.active.forEach(task => {
        activeList.appendChild(createTaskNode(task, 'active'));
    });

    // –†–µ–Ω–¥–µ—Ä –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö
    const completedList = document.getElementById('completedList');
    completedList.innerHTML = '';
    state.completed.forEach(task => {
        completedList.appendChild(createTaskNode(task, 'completed'));
    });

    // –°—á–µ—Ç—á–∏–∫–∏
    document.getElementById('activeCount').textContent = state.active.length;
    document.getElementById('completedCount').textContent = state.completed.length;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    updateStats();

    // –§–∏–ª—å—Ç—Ä—ã (–ö–Ω–æ–ø–∫–∏)
    renderFilters();
    
    // –¢–∞–π–º–µ—Ä—ã
    renderTimers();
}

function createTaskNode(task, type) {
    const div = document.createElement('div');
    div.className = `task ${type === 'completed' ? 'completed' : ''}`;
    
    const bpVal = parseBP(task.bp);
    
    div.innerHTML = `
        <input type="checkbox" ${type === 'completed' ? 'checked' : ''}>
        <div class="task-content">
            <div class="task-title">${task.title}</div>
            <div class="task-info">
                <span class="bp-badge">${bpVal} BP</span>
                ${task.time} –º–∏–Ω
                ${task.userTime ? `<span class="green">(${Math.round(task.userTime/60000)}–º)</span>` : ''}
            </div>
        </div>
        ${type === 'active' ? `<button class="btn-icon timer">‚è±Ô∏è</button>` : ''}
        <button class="btn-icon delete">√ó</button>
    `;

    // –ß–µ–∫–±–æ–∫—Å
    div.querySelector('input').addEventListener('change', () => toggleTask(task, type));
    
    // –£–¥–∞–ª–µ–Ω–∏–µ
    div.querySelector('.delete').addEventListener('click', (e) => {
        e.stopPropagation();
        if(type === 'active') {
            moveToAvailable(task);
        } else {
             // –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
             state.completed = state.completed.filter(t => t.id !== task.id);
             task.checked = false;
             state.available.push(task);
             saveData(); render();
        }
    });

    // –¢–∞–π–º–µ—Ä
    const timerBtn = div.querySelector('.timer');
    if(timerBtn) {
        timerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            addTimer(task.title);
        });
    }

    return div;
}

function renderFilters() {
    const container = document.getElementById('bpGroupFilters');
    container.innerHTML = '';
    
    const groups = {};
    state.available.forEach(t => {
        const g = t.group || '–î—Ä—É–≥–æ–µ';
        if(!groups[g]) groups[g] = 0;
        groups[g]++;
    });

    Object.keys(groups).sort().forEach(group => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = `${group} (${groups[group]})`;
        btn.addEventListener('click', () => openPopover(group));
        container.appendChild(btn);
    });
}

function openPopover(group) {
    const popover = document.getElementById('taskPopover');
    const overlay = document.getElementById('popoverOverlay');
    popover.innerHTML = '';
    
    const tasks = state.available.filter(t => t.group === group);
    
    tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'popover-item';
        div.innerHTML = `<span>${task.title}</span> <span class="info">${task.bp} BP</span>`;
        div.addEventListener('click', () => {
            // –ü–µ—Ä–µ–Ω–æ—Å –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
            state.available = state.available.filter(t => t.id !== task.id);
            state.active.push(task);
            saveData(); render();
            closePopover();
        });
        popover.appendChild(div);
    });
    
    popover.classList.add('open');
    overlay.classList.add('open');
    
    overlay.onclick = closePopover;
}

function closePopover() {
    document.getElementById('taskPopover').classList.remove('open');
    document.getElementById('popoverOverlay').classList.remove('open');
}

// --- –î–ï–ô–°–¢–í–ò–Ø ---
function toggleTask(task, type) {
    if(type === 'active') {
        state.active = state.active.filter(t => t.id !== task.id);
        task.checked = true;
        state.completed.unshift(task);
    } else {
        state.completed = state.completed.filter(t => t.id !== task.id);
        task.checked = false;
        state.active.push(task);
    }
    saveData(); render();
}

function moveToAvailable(task) {
    state.active = state.active.filter(t => t.id !== task.id);
    state.available.push(task);
    saveData(); render();
}

// --- –¢–ê–ô–ú–ï–†–´ ---
function renderTimers() {
    const list = document.getElementById('timerList');
    list.innerHTML = '';
    const profile = state.profiles[state.currentProfile];
    if(!profile) return;

    profile.timers.forEach(timer => {
        const div = document.createElement('div');
        div.className = `timer-item ${timer.end ? 'active' : ''}`;
        
        const timeLeft = timer.end ? Math.max(0, timer.end - Date.now()) : 0;
        const timeStr = formatMs(timeLeft);
        
        div.innerHTML = `
            <div>
                <div style="font-weight:600; font-size:13px;">${timer.name}</div>
                <div class="timer-time">${timer.end ? timeStr : '–ì–æ—Ç–æ–≤'}</div>
            </div>
            <div style="display:flex; gap:5px;">
               ${!timer.end ? `<button class="btn-icon" onclick="startTimer('${timer.id}')">‚ñ∂Ô∏è</button>` : 
               `<button class="btn-icon" onclick="cancelTimer('${timer.id}')">‚èπÔ∏è</button>`}
               <button class="btn-icon delete" onclick="deleteTimer('${timer.id}')">√ó</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function addTimer(name) {
    if(!name) {
        modal.showInput('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞', '–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—á—Ç–∞', (val) => {
             createTimerObj(val);
        });
        return;
    }
    createTimerObj(name);
}

function createTimerObj(name) {
    const profile = state.profiles[state.currentProfile];
    profile.timers.push({
        id: Math.random().toString(36),
        name: name,
        end: null
    });
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ç–∞–π–º–µ—Ä–æ–≤
    document.getElementById('timerPanel').style.display = 'block';
    saveData(); renderTimers();
}

window.startTimer = function(id) {
    modal.showInput('–í—Ä–µ–º—è (–º–∏–Ω –∏–ª–∏ —á)', '–ù–∞–ø—Ä–∏–º–µ—Ä: 4h –∏–ª–∏ 90', (val) => {
        const ms = parseDuration(val);
        if(ms > 0) {
            const profile = state.profiles[state.currentProfile];
            const t = profile.timers.find(x => x.id === id);
            if(t) { t.end = Date.now() + ms; saveData(); renderTimers(); }
        } else {
            showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!');
        }
    });
};

window.cancelTimer = function(id) {
    const profile = state.profiles[state.currentProfile];
    const t = profile.timers.find(x => x.id === id);
    if(t) { t.end = null; saveData(); renderTimers(); }
};

window.deleteTimer = function(id) {
    modal.showConfirm('–£–¥–∞–ª–∏—Ç—å —Ç–∞–π–º–µ—Ä?', () => {
        const profile = state.profiles[state.currentProfile];
        profile.timers = profile.timers.filter(t => t.id !== id);
        saveData(); renderTimers();
    });
};

// --- –£–¢–ò–õ–ò–¢–´ ---
function parseBP(str) { 
    if(!str) return 0;
    const parts = str.split('/'); 
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Ç–æ—Ä–æ–µ —á–∏—Å–ª–æ (VIP) –∏–ª–∏ –ø–µ—Ä–≤–æ–µ –µ—Å–ª–∏ –æ–¥–Ω–æ
    return parts.length > 1 ? parseInt(parts[1]) : parseInt(parts[0]);
}

function parseDuration(str) {
    str = str.toLowerCase();
    let val = parseInt(str);
    if(str.includes('h')) return val * 60 * 60 * 1000;
    return val * 60 * 1000;
}

function formatMs(ms) {
    if(ms <= 0) return '00:00:00';
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    return `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
}

function updateStats() {
    let total = 0;
    state.completed.forEach(t => total += parseBP(t.bp));
    document.getElementById('totalBP').textContent = total;
    
    // –í—Ä–µ–º—è
    let time = 0;
    state.active.forEach(t => time += (t.time || 0));
    document.getElementById('totalTime').textContent = time + ' –º–∏–Ω';
}

function saveData() {
    localStorage.setItem('bp_tracker_tg_v1', JSON.stringify(state));
}

function loadData() {
    const raw = localStorage.getItem('bp_tracker_tg_v1');
    if(raw) state = JSON.parse(raw);
}

function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
}

// --- EVENT LISTENERS ---
document.getElementById('toggleTimers').addEventListener('click', () => {
    const p = document.getElementById('timerPanel');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('addTimerBtn').addEventListener('click', () => {
    addTimer(document.getElementById('newTimerInput').value);
    document.getElementById('newTimerInput').value = '';
});

// –ù–æ–≤—ã–π –¥–µ–Ω—å
document.getElementById('dailyReset').addEventListener('click', () => {
    modal.showConfirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–µ–Ω—å?', () => {
        state.active.push(...state.completed);
        state.completed = [];
        state.active.forEach(t => t.checked = false);
        saveData(); render();
        showToast('–î–µ–Ω—å —Å–±—Ä–æ—à–µ–Ω!');
    });
});

// –ó–æ–ª–æ—Ç–æ–π –¥–µ–Ω—å
document.getElementById('goldenDay').addEventListener('click', () => {
    modal.showConfirm('–ó–∞–≥—Ä—É–∑–∏—Ç—å –ó–æ–ª–æ—Ç–æ–π —Å–ø–∏—Å–æ–∫?', () => {
        // –°–±—Ä–æ—Å –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–æ–ª–æ—Ç–æ–≥–æ
        state.active = [];
        state.completed = [];
        state.available = []; // –û—á–∏—Å—Ç–∏–º –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º
        
        ALL_TASKS.forEach(def => {
           const t = mkTaskFromDef(def);
           if(GOLDEN_TITLES.includes(t.title)) {
               state.active.push(t);
           } else {
               state.available.push(t);
           }
        });
        saveData(); render();
        showToast('–ó–æ–ª–æ—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω');
    });
});

// –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ç–∞–π–º–µ—Ä–æ–≤
setInterval(() => {
    renderTimers();
}, 1000);

// –°—Ç–∞—Ä—Ç
init();

</script>
</body>
</html>
